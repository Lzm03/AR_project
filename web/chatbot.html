<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<title>æ•¸å­—å­”å­</title>

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
</script>

<style>

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: fixed;
}


:root {
  --panel: rgba(28, 28, 30, 0.72);
  --border: rgba(255, 255, 255, 0.08);
  --text: #f5f5f7;
  --purple: #6f2dbd;
  --purple-active: #8f5ae8;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #1a1a1f, #050507);
  font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  color: var(--text);
}

#app {
  display: flex;
  height: 100%;
}

/* ===== å·¦ä¾§ 3D ===== */

#vr {
  flex: 1.2;
  background: url("./class.jpg") center / cover no-repeat;
}

model-viewer {
  position: relative;
  z-index: 2;
  width: 100%;
  height: 100%;
  background: transparent;

  pointer-events: none; /* ğŸ”’ æ ¸å¿ƒï¼šå½»åº•ç¦æ­¢æ‹–åŠ¨ */
}

/* ===== å³ä¾§é¢æ¿ ===== */

#panel {
  width: 420px;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(24px);
  background: var(--panel);
  border-left: 1px solid var(--border);
}

#header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
}

#chat {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 14px;
  line-height: 1.6;
  color: #ffffff;
}
.msg.ai {
  color: #84ff00;
}

#input {
  padding: 16px;
  display: flex;
  gap: 10px;
  align-items: center;
}

#prompt {
  flex: 1;
  padding: 10px;
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: white;
}

/* ===== ğŸ™ éº¦å…‹é£ ===== */

#micWrapper {
  position: relative;
  width: 64px;
  height: 64px;
  cursor: pointer;
}

#micCore {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: var(--purple);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3;
  box-shadow: 0 10px 30px rgba(111,45,189,0.45);
  transition: background 0.4s ease, box-shadow 0.4s ease;
}

.recording #micCore {
  background: var(--purple-active);
  box-shadow: 0 0 40px rgba(143,90,232,0.8);
}

.ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid white;
  z-index: 1;
}

.ring-inner {
  inset: 6px;
  opacity: 0.9;
}

.ring-outer {
  inset: -10px;
  opacity: 0;
  transform: scale(0.9);
}

#sendBtn {
  padding: 10px 16px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(180deg, #6cb6ff, #3a7be0);
  color: white;
  cursor: pointer;
}

#sendBtn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

#sendBtn.stop {
  background: linear-gradient(180deg, #ff4d4d, #c81e1e);
  font-size: 20px;
  padding: 8px 16px;
}


</style>
</head>

<body>

<div id="app">

  <!-- ===== 3D æ•°å­—å­”å­ ===== -->
  <div id="vr">
    <model-viewer
      id="confucius"
      src="./models/idle.glb"
      autoplay

      interaction-prompt="none"

      environment-image="neutral"
      exposure="1.0">
    </model-viewer>

  </div>

  <!-- ===== èŠå¤©é¢æ¿ ===== -->
  <div id="panel">
    <div id="header">
      <b>æ•¸å­—å­”å­</b><br />
      <small>å­æ›° Â· æ…¢è¨€ä»¥æ˜é“</small>
    </div>
    

    <div id="chat"></div>

    <div id="input">
      <input id="prompt" placeholder="ä»¥ç²µèªå‘å­”å­ç™¼å•â‹¯" />

      <div id="micWrapper">
        <div class="ring ring-outer"></div>
        <div class="ring ring-inner"></div>

        <div id="micCore">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <path d="M12 15a3 3 0 003-3V6a3 3 0 10-6 0v6a3 3 0 003 3z"
              stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M19 11a7 7 0 01-14 0"
              stroke="white" stroke-width="2" stroke-linecap="round"/>
            <line x1="12" y1="19" x2="12" y2="22"
              stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <button id="sendBtn">ç™¼é€</button>
    </div>
  </div>
</div>

<script>
/* ===== DOM ===== */

const promptInput = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");
const micWrapper = document.getElementById("micWrapper");
const confucius = document.getElementById("confucius");
// ===== åç«¯åœ°å€é…ç½® =====
const API_BASE = "http://localhost:3001";
const WS_BASE  = "ws://localhost:3002";
let requestId = 0;



/* ===== 3D çŠ¶æ€æ§åˆ¶ ===== */

function playIdle() {
  confucius.src = "./models/idle.glb";
}

function playTalk() {
  confucius.src = "./models/talk.glb";
}

/* ===== èŠå¤© ===== */

let currentAudio = null;
let isLocked = false;
let blockSendOnce = false;




function interruptConfucius() {
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
    currentAudio = null;
  }

  playIdle();
}


function unlock() {
  if (currentAudio) {
    currentAudio.pause();
    currentAudio = null;
  }

  playIdle();

  isLocked = false;
  promptInput.disabled = false;
  sendBtn.textContent = "ç™¼é€";
  sendBtn.classList.remove("stop");
}


async function send() {
  const myRequestId = ++requestId; // ğŸ”‘ æœ¬æ¬¡è¯·æ±‚ç¼–å·

  if (blockSendOnce) {
    blockSendOnce = false;
    return;
  }
  if (isLocked) return;

  isLocked = true;
  promptInput.disabled = true;
  sendBtn.textContent = "â–ªï¸";
  sendBtn.classList.add("stop");

  interruptConfucius();

  const text = promptInput.value.trim();
  if (!text) {
    unlock();
    return;
  }

  promptInput.value = "";
  addMsg("ä½ ", text);

  const res = await fetch(`${API_BASE}/api/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt: text })
  });

  const data = await res.json();

  // ğŸ›‘ å…³é”®ï¼šå¦‚æœè¯·æ±‚å·²è¿‡æœŸï¼Œç›´æ¥ä¸¢å¼ƒ
  if (myRequestId !== requestId) {
    return;
  }

  addMsg("å­”å­", data.text, true);

  if (data.audioUrl) {
    const audioSrc = data.audioUrl.startsWith("http")
      ? data.audioUrl
      : API_BASE + data.audioUrl;

    currentAudio = new Audio(audioSrc);
    playTalk();
    currentAudio.play();
    currentAudio.onended = unlock;
  } else {
    unlock();
  }
}


sendBtn.onclick = () => {
  if (isLocked) {
    requestId++;        // ğŸ”¥ ä½¿æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚å¤±æ•ˆ
    blockSendOnce = true;
    unlock();
  } else {
    send();
  }
};





function addMsg(role, text, ai=false) {
  const chat = document.getElementById("chat");
  chat.innerHTML += `<div class="msg ${ai ? "ai" : ""}">${role}ï¼š${text}</div>`;
  chat.scrollTop = chat.scrollHeight;
}

/* ===== Google Streaming + éº¦å…‹é£åŠ¨ç”» ===== */

function forceInterrupt() {
  // å¦‚æœå­”å­æ­£åœ¨è¯´è¯ or ç³»ç»Ÿé”å®š
  if (isLocked) {
    unlock(); // è¿™ä¸€æ­¥ç­‰ä»·äºç‚¹ â–ªï¸
  } else {
    interruptConfucius();
  }
}

let socket = null;
let mediaRecorder = null;
let isRecording = false;

let audioContext, analyser, micSource, animationId;
let pulsePhase = 0;

micWrapper.onclick = toggleMic;

async function toggleMic() {
  blockSendOnce = isLocked;
  if (isLocked) requestId++; // ğŸ”¥ ç›´æ¥åºŸæ‰å½“å‰è¯·æ±‚
  forceInterrupt();


  if (isRecording) {
    stopMic();
    return;
  }

  socket = new WebSocket(WS_BASE);

  socket.onmessage = e => {
    const d = JSON.parse(e.data);
    if (!d.text) return;

    promptInput.value = d.text;

    if (d.final) {
      send();
      stopMic();
    }
  };

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

  mediaRecorder.ondataavailable = e => {
    if (socket.readyState === 1) socket.send(e.data);
  };

  mediaRecorder.start(0.1);

  audioContext = new AudioContext();
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  micSource = audioContext.createMediaStreamSource(stream);
  micSource.connect(analyser);

  isRecording = true;
  sendBtn.disabled = true;
  micWrapper.classList.add("recording");
  startMicAnimation();
}

function stopMic() {
  mediaRecorder?.state !== "inactive" && mediaRecorder.stop();
  socket?.readyState === 1 && socket.close();

  isRecording = false;
  sendBtn.disabled = false;
  stopMicAnimation();
}

function startMicAnimation() {
  const outer = document.querySelector(".ring-outer");
  const data = new Uint8Array(analyser.frequencyBinCount);

  function animate() {
    analyser.getByteFrequencyData(data);
    const vol = data.reduce((a,b)=>a+b,0) / data.length;

    pulsePhase += 0.05;
    const pulse = Math.sin(pulsePhase) * 0.15 + 1;
    const scale = pulse + Math.min(vol / 120, 0.6);

    outer.style.transform = `scale(${scale})`;
    outer.style.opacity = Math.min(0.3 + vol / 100, 1);

    animationId = requestAnimationFrame(animate);
  }
  animate();
}

function stopMicAnimation() {
  cancelAnimationFrame(animationId);
  micWrapper.classList.remove("recording");

  const outer = document.querySelector(".ring-outer");
  outer.style.transform = "scale(0.9)";
  outer.style.opacity = 0;
}

promptInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();

    if (isLocked) {
      unlock();
    } else {
      send();
    }
  }
});


</script>

</body>
</html>
